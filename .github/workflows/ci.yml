name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  packages: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pywin32-ctypes
        
    - name: Build Windows executable
      shell: cmd
      run: >-
        pyinstaller --name "Sky Folder Selector" --windowed
        --hidden-import pkgutil
        --hidden-import win32ctypes
        --hidden-import win32ctypes.core
        --hidden-import win32ctypes.pywin32
        --hidden-import PyQt6
        --hidden-import PyQt6.sip
        --hidden-import PyQt6.QtCore
        --hidden-import PyQt6.QtGui
        --hidden-import PyQt6.QtWidgets
        --collect-all PyQt6
        --add-data "assets/icons/icon.ico;."
        --icon assets/icons/icon.ico
        --add-binary "%CD%\venv\Lib\site-packages\PyQt6\Qt6\bin\*;PyQt6\Qt6\bin"
        sky_folder_selector.py
        
    - name: List build output
      run: dir dist
        
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: dist/Sky Folder Selector
        retention-days: 5
        compression-level: 9

  build-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Build macOS app
      run: |
        echo "Starting build process..."
        pyinstaller --name "Sky Folder Selector" \
          --windowed \
          --noconfirm \
          --clean \
          --hidden-import pkgutil \
          --hidden-import PyQt6 \
          --hidden-import PyQt6.sip \
          --hidden-import PyQt6.QtCore \
          --hidden-import PyQt6.QtGui \
          --hidden-import PyQt6.QtWidgets \
          --collect-all PyQt6 \
          --add-data "assets/icons/icon.icns:." \
          --icon assets/icons/icon.icns \
          --target-arch arm64 \
          --osx-bundle-identifier "com.sky.folder.selector" \
          sky_folder_selector.py
        
        echo "Creating app bundle structure..."
        APP_DIR="dist/Sky Folder Selector.app"
        mkdir -p "$APP_DIR/Contents/"{MacOS,Resources,Frameworks}
        
        echo "Copying files to app bundle..."
        cp -R "dist/Sky Folder Selector/"* "$APP_DIR/Contents/MacOS/"
        cp "assets/icons/icon.icns" "$APP_DIR/Contents/Resources/"
        
        echo "Creating Info.plist..."
        cat > "$APP_DIR/Contents/Info.plist" << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleDisplayName</key>
            <string>Sky Folder Selector</string>
            <key>CFBundleExecutable</key>
            <string>Sky Folder Selector</string>
            <key>CFBundleIconFile</key>
            <string>icon.icns</string>
            <key>CFBundleIdentifier</key>
            <string>com.sky.folder.selector</string>
            <key>CFBundleInfoDictionaryVersion</key>
            <string>6.0</string>
            <key>CFBundleName</key>
            <string>Sky Folder Selector</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0.0</string>
            <key>LSMinimumSystemVersion</key>
            <string>10.15</string>
            <key>NSHighResolutionCapable</key>
            <true/>
            <key>LSApplicationCategoryType</key>
            <string>public.app-category.utilities</string>
        </dict>
        </plist>
        EOF
        
        echo "Creating DMG..."
        hdiutil create -volname "Sky Folder Selector" -srcfolder "$APP_DIR" -ov -format UDZO "dist/Sky Folder Selector.dmg"
        
    - name: Upload macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-build
        path: dist/Sky Folder Selector.dmg
        retention-days: 5
        compression-level: 9

  create-release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: windows-build
        path: dist/windows
        
    - name: Download macOS artifact
      uses: actions/download-artifact@v4
      with:
        name: macos-build
        path: dist/macos
        
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v1.0.0
        release_name: Sky Folder Selector v1.0.0
        body: |
          # Sky Folder Selector v1.0.0
          
          Sky Folder Selector 是一个简单易用的文件夹选择工具，基于 PyQt6 开发，支持 Windows 和 macOS 平台。
          
          ## 功能特点
          - 简洁的图形界面
          - 支持文件夹选择
          - 跨平台支持（Windows/macOS）
          
          ## 更新内容
          - 初始版本发布
          - 支持 Windows 和 macOS 平台
          - 优化了构建配置，确保所有依赖正确打包
          - 添加了必要的系统权限配置
          - 添加了应用程序图标
          
          ## 使用说明
          1. 下载对应平台的安装包
          2. 运行安装程序
          3. 选择需要处理的文件夹
          
          ## 系统要求
          - Windows 10 或更高版本
          - macOS 10.15 或更高版本
        draft: false
        prerelease: false
        
    - name: Upload Windows Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist/windows/Sky Folder Selector.exe
        asset_name: Sky Folder Selector.exe
        asset_content_type: application/x-msdownload
        
    - name: Upload macOS Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist/macos/Sky Folder Selector.dmg
        asset_name: Sky Folder Selector.dmg
        asset_content_type: application/x-apple-diskimage 