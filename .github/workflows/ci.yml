name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  packages: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Build Windows executable
      run: |
        pyinstaller --name "Sky Folder Selector" --windowed --onefile --hidden-import pkgutil --hidden-import PyQt6 --hidden-import PyQt6.sip --collect-all PyQt6 sky_folder_selector.py
        echo "Build completed"
        
    - name: List build output
      run: dir dist
        
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: dist/Sky Folder Selector.exe
        retention-days: 5
        compression-level: 9

  build-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Build macOS app
      run: |
        echo "Starting build process..."
        pyinstaller --name "Sky Folder Selector" \
          --windowed \
          --onefile \
          --hidden-import pkgutil \
          --hidden-import PyQt6 \
          --hidden-import PyQt6.sip \
          --collect-all PyQt6 \
          --clean \
          --noconfirm \
          sky_folder_selector.py
        echo "Build completed"
        
    - name: List build output
      run: |
        echo "Listing build output directory:"
        ls -la dist/
        echo "Listing build directory:"
        ls -la build/
        
    - name: Create DMG
      run: |
        echo "Creating DMG..."
        hdiutil create -volname "Sky Folder Selector" -srcfolder "dist/Sky Folder Selector" -ov -format UDZO "dist/Sky Folder Selector.dmg"
        echo "DMG created"
        
    - name: Upload macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-build
        path: dist/Sky Folder Selector.dmg
        retention-days: 5
        compression-level: 9

  create-release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v1.0.0
        name: Sky Folder Selector v1.0.0
        body: |
          # Sky Folder Selector v1.0.0
          
          Sky Folder Selector 是一个简单易用的文件夹选择工具，基于 PyQt6 开发，支持 Windows 和 macOS 平台。
          
          ## 功能特点
          - 简洁的图形界面
          - 支持文件夹选择
          - 跨平台支持（Windows/macOS）
          
          ## 更新内容
          - 初始版本发布
          - 支持 Windows 和 macOS 平台
          - 优化了构建配置，确保所有依赖正确打包
          - 添加了必要的系统权限配置
          
          ## 使用说明
          1. 下载对应平台的安装包
          2. 运行安装程序
          3. 选择需要处理的文件夹
          
          ## 系统要求
          - Windows 10 或更高版本
          - macOS 10.15 或更高版本
        draft: false
        prerelease: false
        
    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: windows-build
        path: dist
        
    - name: Download macOS artifact
      uses: actions/download-artifact@v4
      with:
        name: macos-build
        path: dist
        
    - name: Upload Release Assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist/Sky Folder Selector.exe
        asset_name: Sky Folder Selector.exe
        asset_content_type: application/x-msdownload
        
    - name: Upload macOS Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist/Sky Folder Selector.dmg
        asset_name: Sky Folder Selector.dmg
        asset_content_type: application/x-apple-diskimage 